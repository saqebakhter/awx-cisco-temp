---
- name: get instances list
  hosts: 10.40.84.47
  remote_user: root
  tasks:
  - shell: nsxdp-cli vswitch instance list --json-output
    register: vswitch_list 
    
  - set_fact: 
      vswitch_list_json: "{{ vswitch_list.stdout | from_json }}"
      
  - name: init fact
    set_fact:
      ievd_hosts: "[]"
  
  - name: Create ports dictionary (this is now per port)
    set_fact:
      ports: "{{ vswitch_list_json | json_query('*.ports') }}"


  - name: Loop through JSON and make calls to items with client name IEVD
    include_tasks: inner-vdan.yml
    loop: "{{ vminfo.virtual_machines }}"
    loop_control:
      loop_var: outer_item
    loop: "{{ vswitch_list_json['DvsPortset-1'].ports }}"
    when: "'ievd' in outer_item.client or 'vPLC' in outer_item.client"    



    



      